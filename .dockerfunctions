#!/bin/bash
# Bash wrappers for docker run commands

export DOCKER_REPO_PREFIX=miel

#
# Helper Functions
#
alias dstopall='docker stop $(docker ps -q)'

dcleanup(){
  docker rm $(docker ps -aq 2>/dev/null) 2>/dev/null
  docker rm -v $(docker ps --filter status=exited -q 2>/dev/null) 2>/dev/null
  docker rmi $(docker images --filter dangling=true -q 2>/dev/null) 2>/dev/null
  docker volume rm $(docker volume ls -qf dangling=true 2>/dev/null) 2>/dev/null
  docker network prune 2>/dev/null
  docker image prune -a -f --filter "until=4320h" 2>/dev/null
}

del_stopped(){
  local name=$1
  local state=$(docker inspect --format "{{.State.Running}}" $name 2>/dev/null)

  if [[ "$state" == "false" ]]; then
    docker rm $name
  fi
}

relies_on(){
  local containers=$@

  for container in $containers; do
    local state=$(docker inspect --format "{{.State.Running}}" $container 2>/dev/null)

    if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
      echo "$container is not running, starting it for you."
      $container
    fi
  done
}

# creates an nginx config for a local route
nginx_config(){
  server=$1
  route=$2

  cat >"${HOME}/.nginx/conf.d/${server}.conf" <<-EOF
        upstream ${server} { server ${route}; }
        server {
        server_name ${server};
        location / {
        proxy_pass  http://${server};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$http_host;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header X-Forwarded-For \$remote_addr;
        proxy_set_header X-Forwarded-Port \$server_port;
        proxy_set_header X-Request-Start \$msec;
      }
    }
EOF

  # restart nginx
  docker restart nginx

  # add host to /etc/hosts
  hostess add "$server" 127.0.0.1

  # open browser
  browser-exec "http://${server}"
}


#
# Container Aliases
#

gimp(){
  del_stopped gimp

  docker run -d \
    -v /etc/localtime:/etc/localtime:ro \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -e "DISPLAY=unix${DISPLAY}" \
    -v "${HOME}/Pictures:/root/Pictures" \
    -v "${HOME}/.gtkrc:/root/.gtkrc" \
    -e GDK_SCALE \
    -e GDK_DPI_SCALE \
    --name gimp \
    jess/gimp
}

hollywood(){
  docker run --rm -it \
    --name hollywood \
    jess/hollywood
}

htop(){
  docker run --rm -it \
    --pid host \
    --net none \
    --name htop \
    jess/htop
}

# nginx(){
# 	del_stopped nginx
#
# 	docker run -d \
# 		--restart always \
# 		-v "${HOME}/.nginx:/etc/nginx" \
# 		--net host \
# 		--name nginx \
# 		nginx
# }

transmission(){
  del_stopped transmission

  docker run -d \
    -v /etc/localtime:/etc/localtime:ro \
    -v "${HOME}/Torrents:/transmission/download" \
    -v "${HOME}/.transmission:/transmission/config" \
    -p 9091:9091 \
    -p 51413:51413 \
    -p 51413:51413/udp \
    --name transmission \
    ${DOCKER_REPO_PREFIX}/transmission

  hostess add transmission "$(docker inspect --format '{{.NetworkSettings.Networks.bridge.IPAddress}}' transmission)"
  browser-exec "http://transmission:9091"
}
